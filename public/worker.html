<!DOCTYPE html>
<html>
<head>
  <title>Worker Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --card: rgba(255,255,255,0.10);
      --card2: rgba(255,255,255,0.14);
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: #2d89ef;
      --accent2: #00c2a8;
      --danger: #ff4d6d;
      --shadow: 0 18px 45px rgba(0,0,0,0.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      min-height:100vh;
      background:
        linear-gradient(120deg, rgba(11,18,32,0.78), rgba(11,18,32,0.58)),
        url("pigeon.jpeg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .wrap{ max-width: 1100px; margin:0 auto; padding: 16px 16px 28px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .badge{ width:42px;height:42px;border-radius:14px; background: linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow: var(--shadow); }
    h1{ margin:0; font-size:18px; }
    .sub{ margin:2px 0 0; font-size:12px; color: var(--muted); }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:700;
    }
    .btnPrimary{ border:none; background: linear-gradient(135deg,var(--accent),#5aa7ff); color:#fff; }
    .btnDanger{ border:none; background: linear-gradient(135deg,var(--danger),#ff7a90); color:#fff; }

    .banner{
      background: rgba(45,137,239,0.18);
      border: 1px solid rgba(45,137,239,0.35);
      border-radius: 18px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      margin-bottom: 14px;
      line-height:1.35;
      font-size: 13px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .cardHead h2{ margin:0; font-size:14px; }
    .cardBody{ padding: 14px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
      font-weight: 700;
    }
    .tab.active{
      background: rgba(45,137,239,0.25);
      border-color: rgba(45,137,239,0.45);
      color: var(--text);
    }

    .pigeonList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){ .pigeonList{ grid-template-columns:1fr; } }

    .pigeon{
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .pTitle{ margin:0; font-size:13px; font-weight:900; }
    .pMeta{ margin:4px 0 0; color: var(--muted); font-size:12px; line-height:1.3; }
    .pill{
      display:inline-block; padding: 4px 8px; border-radius: 999px;
      font-size: 11px; background: rgba(45,137,239,0.22);
      border: 1px solid rgba(45,137,239,0.35);
      margin-left: 8px;
    }

    input, textarea, select{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline:none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.55); }
    textarea{ min-height: 90px; resize: vertical; }

    .formRow{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px; }
    @media (max-width: 520px){ .formRow{ grid-template-columns:1fr; } }

    .helper{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 10px;
    }

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .note{
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      line-height:1.35;
    }
    .note b{ font-size: 12px; }

    /* Modal */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width:min(680px, 100%);
      background: rgba(16,24,40,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHead{
      padding: 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      gap: 10px;
    }
    .modalHead h3{ margin:0; font-size:14px; }
    .modalBody{ padding: 14px; }
    .ruleList{ margin:0; padding-left: 18px; line-height:1.6; font-size:13px; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="badge"></div>
        <div>
          <h1>Worker Panel</h1>
          <div class="sub">Control Panel • Feeding • Guidance</div>
        </div>
      </div>
      <button class="btn btnDanger" onclick="logout()">Logout</button>
    </div>

    <div class="banner" id="planBanner">Loading plan…</div>

    <div class="grid">
      <!-- LEFT: Control Panel -->
      <div class="card">
        <div class="cardHead">
          <h2>Control Panel</h2>
          <div class="tabs">
            <div class="tab active" id="tabPigeons" onclick="showTab('pigeons')">Pigeons</div>
            <div class="tab" id="tabGuidance" onclick="showTab('guidance')">Guidance Library</div>
            <div class="tab" id="tabNotifs" onclick="showTab('notifs')">Notifications</div>
          </div>
        </div>

        <div class="cardBody">
          <!-- PIGEONS -->
          <div id="panePigeons">
            <div class="pigeonList" id="pigeonList"></div>
            <div class="helper">
              Tap a pigeon to view profile + feeding guidance from management. Recommended portions auto-adjust when races are close.
            </div>
          </div>

          <!-- GUIDANCE -->
          <div id="paneGuidance" style="display:none;">
            <div class="formRow">
              <select id="gCategory" onchange="loadGuidance()">
                <option value="feeding">Feeding</option>
                <option value="breeding">Breeding</option>
                <option value="handling">Handling</option>
                <option value="race">Races</option>
                <option value="newborn">Newborn</option>
                <option value="health">Health</option>
              </select>
              <input id="gSearch" placeholder="Search guidance..." oninput="debouncedGuidance()">
            </div>

            <div class="list" id="guidanceList"></div>

            <div class="helper">
              Guidance is managed by management in the Manager Dashboard and updates automatically here.
            </div>
          </div>

          <!-- NOTIFICATIONS -->
          <div id="paneNotifs" style="display:none;">
            <div class="list" id="notifList"></div>
            <div class="helper">
              Notifications include race plan changes and health alerts that management wants workers to see.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Actions -->
      <div class="card">
        <div class="cardHead">
          <h2>Actions</h2>
          <div class="sub" id="planTiny">—</div>
        </div>

        <div class="cardBody">

          <div class="card" style="box-shadow:none;background:rgba(255,255,255,0.06); border-radius:16px;">
            <div class="cardHead" style="border-bottom:none;">
              <h2>Record Feeding</h2>
            </div>
            <div class="cardBody">
              <div class="formRow">
                <input id="feedPigeon" placeholder="Pigeon code (e.g. Pigeon 1)">
                <input id="feedAmount" type="number" placeholder="Amount (grams)">
              </div>
              <button class="btn btnPrimary" style="width:100%" onclick="submitFeed()">Submit Feeding</button>
              <div class="helper" id="feedHint" style="margin-top:10px;">
                Tip: Select a pigeon from the Control Panel to auto-fill recommended grams.
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="box-shadow:none;background:rgba(255,255,255,0.06); border-radius:16px;">
            <div class="cardHead" style="border-bottom:none;">
              <h2>Report Health Issue</h2>
            </div>
            <div class="cardBody">
              <input id="healthPigeon" placeholder="Pigeon code (e.g. Pigeon 3)">
              <textarea id="healthIssue" placeholder="Describe issue (e.g. not eating, weak, injury...)"></textarea>
              <button class="btn btnPrimary" style="width:100%" onclick="submitHealth()">Submit Report</button>
              <div class="helper" id="healthAdvice" style="display:none;"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" onclick="hideModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Pigeon</h3>
        <button class="btn" onclick="hideModal()">Close</button>
      </div>
      <div class="modalBody">
        <div id="modalMeta" class="note"></div>
        <div style="height:10px"></div>
        <div class="note"><b>Guidance</b></div>
        <ul class="ruleList" id="modalRules"></ul>
      </div>
    </div>
  </div>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(()=>{});
  }

  let pigeons = [];
  let currentPlan = null;

  function showTab(which){
    document.getElementById("panePigeons").style.display = (which==="pigeons") ? "" : "none";
    document.getElementById("paneGuidance").style.display = (which==="guidance") ? "" : "none";
    document.getElementById("paneNotifs").style.display = (which==="notifs") ? "" : "none";

    document.getElementById("tabPigeons").classList.toggle("active", which==="pigeons");
    document.getElementById("tabGuidance").classList.toggle("active", which==="guidance");
    document.getElementById("tabNotifs").classList.toggle("active", which==="notifs");

    if(which==="guidance") loadGuidance();
    if(which==="notifs") loadNotifs();
  }

  async function logout(){
    await fetch("/logout", { method:"POST", credentials:"include" });
    window.location = "/";
  }

  function openModal(p){
    const title = p.code + (p.name ? " • " + p.name : "");
    document.getElementById("modalTitle").innerText = title;

    const rec = p.recommended || {};
    const meta = `
      <b>Profile</b><br>
      Status: ${p.status || "-"}<br>
      Loft: ${p.loft_section || "-"}<br>
      Sex: ${p.sex || "-"}<br>
      Breed: ${p.breed || "-"}<br>
      Base grams: Morning ${p.morning_base_grams ?? "-"}g, Evening ${p.evening_base_grams ?? "-"}g<br>
      <b>Recommended (${rec.plan || "-"})</b>: Morning ${rec.morning_grams ?? "-"}g, Evening ${rec.evening_grams ?? "-"}g
    `;
    document.getElementById("modalMeta").innerHTML = meta;

    const rules = (p.guidance || "").split("\n").map(x=>x.trim()).filter(Boolean);
    const ul = document.getElementById("modalRules");
    ul.innerHTML = rules.length ? rules.map(r=>`<li>${escapeHtml(r)}</li>`).join("") : "<li>No guidance set yet. Follow management guide.</li>";

    // Auto-fill feeding form with selected pigeon + recommended grams
    document.getElementById("feedPigeon").value = p.code;
    if(p.recommended && p.recommended.morning_grams != null){
      // If current time is closer to evening or morning, you can choose; we keep simple: put morning rec
      document.getElementById("feedAmount").value = p.recommended.morning_grams;
      document.getElementById("feedHint").innerText = `Auto-filled recommended grams for ${p.code}. You can change grams if needed.`;
    }

    document.getElementById("modalBackdrop").style.display = "flex";
  }

  function hideModal(){
    document.getElementById("modalBackdrop").style.display = "none";
  }

  async function loadPlan(){
    const res = await fetch("/api/worker/today-plan", { credentials:"include" });
    if(!res.ok){
      document.getElementById("planBanner").innerText = "Could not load plan. Check connection.";
      return;
    }
    const data = await res.json();
    currentPlan = data.plan;

    const parts = [];
    parts.push(`<b>${escapeHtml(data.message || "Plan active")}</b>`);
    if(data.plan){
      parts.push(`Feeding times: <b>${data.plan.morning_time}</b> & <b>${data.plan.evening_time}</b>`);
      parts.push(`Portions: Morning ${data.plan.morning_percent}% • Evening ${data.plan.evening_percent}%`);
      parts.push(`Hydration: ${escapeHtml(data.plan.hydration_note || "")}`);
    }
    if(data.breeding){
      parts.push(`<span class="pill">Breeding</span> Stage: <b>${escapeHtml(data.breeding.stage)}</b> • ${escapeHtml(data.breeding.notes || "")}`);
    }
    document.getElementById("planBanner").innerHTML = parts.join("<br>");
    document.getElementById("planTiny").innerText = data.plan ? `${data.plan.name} (${data.plan.morning_time}/${data.plan.evening_time})` : "—";
  }

  async function loadPigeons(){
    const res = await fetch("/api/worker/pigeons", { credentials:"include" });
    if(!res.ok){
      document.getElementById("pigeonList").innerHTML = `<div class="note">Could not load pigeons.</div>`;
      return;
    }
    pigeons = await res.json();

    const list = document.getElementById("pigeonList");
    list.innerHTML = "";
    if(!pigeons.length){
      list.innerHTML = `<div class="note">No pigeons added yet. Ask management to add pigeons in the Manager Dashboard.</div>`;
      return;
    }

    pigeons.forEach(p=>{
      const rec = p.recommended || {};
      const item = document.createElement("div");
      item.className = "pigeon";
      item.innerHTML = `
        <div>
          <p class="pTitle">${escapeHtml(p.code)} <span class="pill">${escapeHtml(rec.plan || "Plan")}</span></p>
          <p class="pMeta">
            Recommended: Morning <b>${rec.morning_grams ?? "-"}</b>g • Evening <b>${rec.evening_grams ?? "-"}</b>g
          </p>
        </div>
        <button class="btn btnPrimary" onclick='openModal(${JSON.stringify(p).replace(/'/g,"\\'")})'>View</button>
      `;
      // Safer click binding:
      item.querySelector("button").onclick = ()=>openModal(p);
      list.appendChild(item);
    });
  }

  async function submitFeed(){
    const pigeon_code = document.getElementById("feedPigeon").value.trim();
    const amount_grams = document.getElementById("feedAmount").value.trim();
    if(!pigeon_code || !amount_grams) return alert("Please fill pigeon code and grams.");

    const res = await fetch("/feed", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ pigeon_code, amount_grams })
    });
    const text = await res.text();
    if(!res.ok) return alert("Failed: " + text);
    alert(text);
    document.getElementById("feedAmount").value = "";
  }

  async function submitHealth(){
    const pigeon_code = document.getElementById("healthPigeon").value.trim();
    const issue = document.getElementById("healthIssue").value.trim();
    if(!pigeon_code || !issue) return alert("Please fill pigeon code and issue.");

    const res = await fetch("/health", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ pigeon_code, issue })
    });
    const data = await res.json().catch(()=>null);
    if(!data || data.status!=="ok") return alert("Failed to submit report.");

    const box = document.getElementById("healthAdvice");
    box.style.display = "";
    box.innerHTML = `<b>Guidance (${escapeHtml(data.severity)}):</b> ${escapeHtml(data.advice)}`;
    alert("Health report saved.");
    document.getElementById("healthIssue").value = "";
  }

  let guidanceTimer = null;
  function debouncedGuidance(){
    if(guidanceTimer) clearTimeout(guidanceTimer);
    guidanceTimer = setTimeout(loadGuidance, 350);
  }

  async function loadGuidance(){
    const category = document.getElementById("gCategory").value;
    const q = document.getElementById("gSearch").value.trim();

    const url = new URL(location.origin + "/api/worker/guidance");
    url.searchParams.set("category", category);
    if(q) url.searchParams.set("q", q);

    const res = await fetch(url.toString(), { credentials:"include" });
    if(!res.ok){
      document.getElementById("guidanceList").innerHTML = `<div class="note">Could not load guidance.</div>`;
      return;
    }
    const rows = await res.json();
    const list = document.getElementById("guidanceList");
    list.innerHTML = "";

    if(!rows.length){
      list.innerHTML = `<div class="note">No guidance articles found for this category.</div>`;
      return;
    }

    rows.forEach(a=>{
      const div = document.createElement("div");
      div.className = "note";
      const bullets = (a.content || "").split("\n").map(x=>x.trim()).filter(Boolean);
      div.innerHTML = `
        <b>${escapeHtml(a.title)}</b> <span class="pill">${escapeHtml(a.season || "all")}</span><br>
        ${bullets.slice(0,6).map(b=>`• ${escapeHtml(b)}`).join("<br>")}
        ${bullets.length>6 ? "<br><i style='color:rgba(255,255,255,0.65)'>…more</i>" : ""}
      `;
      list.appendChild(div);
    });
  }

  async function loadNotifs(){
    const res = await fetch("/api/worker/notifications", { credentials:"include" });
    const list = document.getElementById("notifList");
    list.innerHTML = "";
    if(!res.ok){
      list.innerHTML = `<div class="note">Could not load notifications.</div>`;
      return;
    }
    const rows = await res.json();
    if(!rows.length){
      list.innerHTML = `<div class="note">No notifications.</div>`;
      return;
    }

    rows.forEach(n=>{
      const div = document.createElement("div");
      div.className = "note";
      div.innerHTML = `
        <b>${escapeHtml(n.title)}</b> <span class="pill">${escapeHtml(n.severity)}</span><br>
        ${escapeHtml(n.message)}<br>
        <span style="color:rgba(255,255,255,0.65)">${escapeHtml(n.created_at || "")}</span>
      `;
      list.appendChild(div);
    });
  }

  function escapeHtml(str){
    str = String(str ?? "");
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Init
  loadPlan();
  loadPigeons();
</script>
</body>
</html>