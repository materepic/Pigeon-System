<!DOCTYPE html>
<html>
<head>
  <title>Worker Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,0.10);
      --card2: rgba(255,255,255,0.14);
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent: #2d89ef;
      --accent2: #00c2a8;
      --danger: #ff4d6d;
      --shadow: 0 18px 45px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        linear-gradient(120deg, rgba(11,18,32,0.75), rgba(11,18,32,0.55)),
        url("pigeon.jpeg");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 30px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .brandBadge{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow);
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      user-select:none;
    }
    .btn:active{ transform: scale(0.99); }
    .btnPrimary{
      border: none;
      background: linear-gradient(135deg, var(--accent), #5aa7ff);
      color: white;
      font-weight: 600;
    }
    .btnDanger{
      border: none;
      background: linear-gradient(135deg, var(--danger), #ff7a90);
      color: white;
      font-weight: 600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 14px;
    }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .cardHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .cardBody{ padding: 14px; }

    .statusRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    @media (max-width: 520px){
      .statusRow{ grid-template-columns: 1fr; }
    }

    .status{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
    }
    .statusLabel{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .statusValue{
      font-size: 14px;
      font-weight: 650;
      line-height: 1.25;
    }

    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 10px;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      cursor:pointer;
      font-size: 12px;
    }
    .tab.active{
      background: rgba(45,137,239,0.25);
      border-color: rgba(45,137,239,0.45);
      color: var(--text);
      font-weight: 600;
    }

    .pigeonList{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .pigeonList{ grid-template-columns: 1fr; }
    }

    .pigeon{
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .pigeonTitle{
      font-weight: 700;
      font-size: 13px;
      margin:0;
    }
    .pigeonMeta{
      margin: 4px 0 0;
      font-size: 12px;
      color: var(--muted);
    }

    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media (max-width: 520px){
      .formRow{ grid-template-columns: 1fr; }
    }

    input, textarea, select{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      outline: none;
    }
    input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.55); }
    textarea{ min-height: 92px; resize: vertical; }

    .helper{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      border-radius: 14px;
      margin-top: 10px;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th, .table td{
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      text-align:left;
      vertical-align: top;
      color: var(--text);
    }
    .table th{ color: rgba(255,255,255,0.75); font-weight: 650; }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modal{
      width:min(640px, 100%);
      background: rgba(16,24,40,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHead{
      padding: 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .modalHead h3{
      margin:0;
      font-size: 14px;
    }
    .modalBody{ padding: 14px; color: var(--text); }
    .ruleList{
      margin: 0;
      padding-left: 18px;
      color: rgba(255,255,255,0.86);
      line-height: 1.6;
      font-size: 13px;
    }
    .pill{
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(45,137,239,0.22);
      border: 1px solid rgba(45,137,239,0.35);
      color: rgba(255,255,255,0.92);
      margin-left: 8px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="brandBadge"></div>
        <div>
          <h1>Pigeon Management</h1>
          <p id="who">Worker Panel</p>
        </div>
      </div>
      <button class="btn btnDanger" onclick="logout()">Logout</button>
    </div>

    <div class="grid">

      <!-- LEFT: Control Panel -->
      <div class="card">
        <div class="cardHead">
          <h2>Control Panel</h2>
          <div style="font-size:12px;color:var(--muted)">Tap a pigeon to see feeding guidance</div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabPigeons" onclick="showSection('pigeons')">Pigeons</div>
          <div class="tab" id="tabFeedings" onclick="showSection('feedings')">Recent Feedings</div>
        </div>

        <div class="cardBody">

          <!-- PIGEON LIST -->
          <div id="sectionPigeons">
            <div class="pigeonList" id="pigeonList"></div>

            <div class="helper">
              <b>Tip:</b> If you are unsure, open the pigeon guidance first, then record the feeding in the Actions panel.
            </div>
          </div>

          <!-- RECENT FEEDINGS -->
          <div id="sectionFeedings" style="display:none">
            <table class="table" id="feedsTable">
              <thead>
                <tr>
                  <th>Worker</th>
                  <th>Pigeon</th>
                  <th>Amount</th>
                  <th>Time</th>
                </tr>
              </thead>
              <tbody id="feedsBody"></tbody>
            </table>

            <div class="helper">
              This shows the most recent feedings recorded in the system.
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: Actions + Status -->
      <div class="card">
        <div class="cardHead">
          <h2>Actions</h2>
          <div style="font-size:12px;color:var(--muted)">Record feeding or health report</div>
        </div>

        <div class="cardBody">

          <div class="statusRow">
            <div class="status">
              <div class="statusLabel">Schedule</div>
              <div class="statusValue" id="scheduleBox">Loading...</div>
            </div>
            <div class="status">
              <div class="statusLabel">Weather Guide</div>
              <div class="statusValue" id="weatherBox">Loading...</div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="card" style="background: rgba(255,255,255,0.06); border-radius:16px; box-shadow:none;">
            <div class="cardHead" style="border-bottom:none; padding:12px 12px 0;">
              <h2>Record Feeding</h2>
            </div>
            <div class="cardBody" style="padding:12px;">
              <div class="formRow">
                <input id="pigeonId" placeholder="Pigeon ID (e.g. Pigeon 1)">
                <input id="amount" type="number" placeholder="Amount (grams)">
              </div>
              <button class="btn btnPrimary" style="width:100%" onclick="feed()">Submit Feeding</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="background: rgba(255,255,255,0.06); border-radius:16px; box-shadow:none;">
            <div class="cardHead" style="border-bottom:none; padding:12px 12px 0;">
              <h2>Report Health Issue</h2>
            </div>
            <div class="cardBody" style="padding:12px;">
              <input id="healthPigeonId" placeholder="Pigeon ID (e.g. Pigeon 3)">
              <textarea id="issue" placeholder="Describe the issue (e.g. not eating, weak, injury)"></textarea>
              <button class="btn btnPrimary" style="width:100%" onclick="health()">Submit Report</button>
              <div class="helper" id="adviceBox" style="display:none;"></div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="modalBackdrop" id="modalBackdrop" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalHead">
        <h3 id="modalTitle">Pigeon Guidance</h3>
        <button class="btn" onclick="hideModal()">Close</button>
      </div>
      <div class="modalBody">
        <div id="modalSubtitle" style="color:var(--muted);font-size:12px;margin-bottom:10px;"></div>
        <ul class="ruleList" id="modalRules"></ul>
      </div>
    </div>
  </div>

<script>
  // Same-origin API (works on Render + phones)
  // No "const API = http://localhost..."
  // Just fetch("/route")


 let pigeonGuidance = {};

async function loadPigeonGuidance(){
  const res = await fetch("/api/worker/pigeons", { credentials:"include" });
  if(!res.ok){
    // show friendly message if none
    pigeonGuidance = {};
    renderPigeons();
    return;
  }
  const rows = await res.json();

  pigeonGuidance = {};
  rows.forEach(p=>{
    const title = p.code || p.name || "Pigeon";
    const subtitle = `Morning: ${p.feed_morning_grams ?? "-"}g • Evening: ${p.feed_evening_grams ?? "-"}g`;
    const rules = [];

    if(p.guidance && p.guidance.trim()){
      // split guidance into bullet points by newline
      p.guidance.split("\n").map(s=>s.trim()).filter(Boolean).forEach(line=>rules.push(line));
    } else {
      rules.push("No guidance set yet. Please follow management guide.");
    }

    pigeonGuidance[title] = { subtitle, rules };
  });

  renderPigeons();
}

  // Build pigeon list UI
  function renderPigeons(){
    const list = document.getElementById("pigeonList");
    const keys = Object.keys(pigeonGuidance);

    list.innerHTML = "";
    keys.forEach((name, i) => {
      const item = document.createElement("div");
      item.className = "pigeon";
      item.innerHTML = `
        <div>
          <p class="pigeonTitle">${name} <span class="pill">Guidance</span></p>
          <p class="pigeonMeta">${pigeonGuidance[name].subtitle}</p>
        </div>
        <button class="btn btnPrimary" onclick="openGuidance('${name.replace(/'/g,"\\'")}')">View</button>
      `;
      list.appendChild(item);
    });
  }

  function showSection(which){
    document.getElementById("sectionPigeons").style.display = (which === "pigeons") ? "" : "none";
    document.getElementById("sectionFeedings").style.display = (which === "feedings") ? "" : "none";

    document.getElementById("tabPigeons").classList.toggle("active", which === "pigeons");
    document.getElementById("tabFeedings").classList.toggle("active", which === "feedings");
  }

  function openGuidance(pigeonName){
    const g = pigeonGuidance[pigeonName];
    document.getElementById("modalTitle").innerText = pigeonName + " – Feeding Guide";
    document.getElementById("modalSubtitle").innerText = g.subtitle;

    const ul = document.getElementById("modalRules");
    ul.innerHTML = g.rules.map(r => `<li>${r}</li>`).join("");

    document.getElementById("modalBackdrop").style.display = "flex";
  }

  function hideModal(){
    document.getElementById("modalBackdrop").style.display = "none";
  }

  function closeModal(e){
    // clicking backdrop closes
    hideModal();
  }

  async function logout(){
    await fetch("/logout", { method:"POST", credentials:"include" });
    window.location = "/";
  }

  async function feed(){
    const pigeonId = document.getElementById("pigeonId").value.trim();
    const amount = document.getElementById("amount").value.trim();

    if(!pigeonId || !amount) return alert("Please fill Pigeon ID and Amount.");

    const res = await fetch("/feed",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ pigeonId, amount })
    });

    const msg = await res.text();
    alert(msg);
    document.getElementById("pigeonId").value="";
    document.getElementById("amount").value="";
    loadRecentFeeds();
  }

  async function health(){
    const pigeon_id = document.getElementById("healthPigeonId").value.trim();
    const issue = document.getElementById("issue").value.trim();
    if(!pigeon_id || !issue) return alert("Please fill Pigeon ID and Issue.");

    const res = await fetch("/health",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body: JSON.stringify({ pigeon_id, issue })
    });

    // your server returns JSON {status:"saved", advice:"..."}
    let data;
    try{ data = await res.json(); } catch(e){ data = null; }

    if(data && data.advice){
      const box = document.getElementById("adviceBox");
      box.style.display = "";
      box.innerHTML = `<b>Guidance:</b> ${data.advice}`;
    }

    alert("Health report saved.");
    document.getElementById("healthPigeonId").value="";
    document.getElementById("issue").value="";
  }

  async function loadSchedule(){
    const t = await fetch("/schedule").then(r=>r.text());
    document.getElementById("scheduleBox").innerText = t;
  }

  async function loadWeather(){
    const t = await fetch("/weather-guide").then(r=>r.text());
    document.getElementById("weatherBox").innerText = t;
  }

  // Recent feeds are manager-protected in your latest setup.
  // If you want workers to see recent feeds too, add a worker-safe endpoint.
  // For now we'll try manager endpoint; if forbidden, we just hide it.
  async function loadRecentFeeds(){
    const tbody = document.getElementById("feedsBody");
    tbody.innerHTML = `<tr><td colspan="4" style="color:rgba(255,255,255,0.7)">Loading…</td></tr>`;

    const res = await fetch("/api/worker/recent-feeds", { credentials:"include" });
    if(!res.ok){
      tbody.innerHTML = `<tr><td colspan="4" style="color:rgba(255,255,255,0.7)">
        Recent feedings are not available for workers in this version.
      </td></tr>`;
      return;
    }

    const rows = await res.json();
    const top = rows.slice(0, 10);

    tbody.innerHTML = top.map(r => `
      <tr>
        <td>${r.worker || ""}</td>
        <td>${r.pigeonId || ""}</td>
        <td>${r.amount || ""}</td>
        <td>${r.time || ""}</td>
      </tr>
    `).join("");
  }

  // Initialize
  loadPigeonGuidance();
  loadSchedule();
  loadWeather();
  loadRecentFeeds();
</script>
</body>
</html>