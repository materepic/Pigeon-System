<!DOCTYPE html>
<html>
<head>
  <title>Manager Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Manager Dashboard</h2>
  <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
</div>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><button class="nav-link active" onclick="showTab('logs')">Logs</button></li>
  <li class="nav-item"><button class="nav-link" onclick="showTab('workers')">Workers</button></li>
  <li class="nav-item"><button class="nav-link" onclick="showTab('analytics')">Analytics</button></li>
  <li class="nav-item"><button class="nav-link" onclick="showTab('finger')">Fingerprint</button></li>
</ul>

<div id="tab-logs">
  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header"><b>Feeding Logs</b></div>
        <div class="card-body table-responsive">
          <table class="table table-sm" id="feedTable"></table>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header"><b>Health Reports</b></div>
        <div class="card-body table-responsive">
          <table class="table table-sm" id="healthTable"></table>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="tab-workers" style="display:none">
  <div class="card">
    <div class="card-header"><b>Manage Workers</b></div>
    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="col"><input id="newName" class="form-control" placeholder="Worker name"></div>
        <div class="col"><input id="newPin" class="form-control" placeholder="PIN"></div>
        <div class="col-auto"><button class="btn btn-primary" onclick="addWorker()">Add</button></div>
      </div>
      <div class="table-responsive">
        <table class="table table-sm" id="workersTable"></table>
      </div>
    </div>
  </div>
</div>

<div id="tab-analytics" style="display:none">
  <div class="card">
    <div class="card-header"><b>Feeding Activity (Last 14 Days)</b></div>
    <div class="card-body">
      <canvas id="feedChart"></canvas>
    </div>
  </div>
</div>

<div id="tab-finger" style="display:none">
  <div class="card">
    <div class="card-header"><b>Enroll Fingerprint (WebAuthn)</b></div>
    <div class="card-body">
      <p class="text-muted">This uses phone/laptop biometrics (fingerprint/FaceID) â€” no extra hardware.</p>
      <div class="row g-2 mb-3">
        <div class="col"><input id="enrollWorkerId" class="form-control" placeholder="Worker ID"></div>
        <div class="col-auto"><button class="btn btn-success" onclick="enroll()">Enroll</button></div>
      </div>
      <div id="enrollMsg"></div>
    </div>
  </div>
</div>

<script>
function showTab(name){
  ["logs","workers","analytics","finger"].forEach(t=>{
    document.getElementById("tab-"+t).style.display = (t===name) ? "" : "none";
  });
  document.querySelectorAll(".nav-link").forEach((b,i)=>{
    const map=["logs","workers","analytics","finger"];
    b.classList.toggle("active", map[i]===name);
  });
}

async function logout(){
  await fetch("/logout", { method:"POST" });
  window.location = "/";
}

async function loadFeeds(){
  const res = await fetch("/api/manager/feed-logs");
  if(!res.ok) return;
  const data = await res.json();
  const t = document.getElementById("feedTable");
  t.innerHTML = `<tr><th>Worker</th><th>Pigeon</th><th>Amount</th><th>Time</th></tr>`;
  data.forEach(r=>{
    t.innerHTML += `<tr>
      <td>${r.workerName || ""}</td>
      <td>${r.pigeonId || ""}</td>
      <td>${r.amount || ""}</td>
      <td>${r.time || ""}</td>
    </tr>`;
  });
}

async function loadHealth(){
  const res = await fetch("/api/manager/health-logs");
  if(!res.ok) return;
  const data = await res.json();
  const t = document.getElementById("healthTable");
  t.innerHTML = `<tr><th>Worker</th><th>Pigeon</th><th>Issue</th><th>Time</th></tr>`;
  data.forEach(r=>{
    t.innerHTML += `<tr>
      <td>${r.worker || ""}</td>
      <td>${r.pigeon_id || ""}</td>
      <td>${r.issue || ""}</td>
      <td>${r.time || ""}</td>
    </tr>`;
  });
}

async function loadWorkers(){
  const res = await fetch("/api/manager/workers");
  if(!res.ok) return;
  const data = await res.json();
  const t = document.getElementById("workersTable");
  t.innerHTML = `<tr><th>ID</th><th>Name</th><th>Action</th></tr>`;
  data.forEach(w=>{
    t.innerHTML += `<tr>
      <td>${w.id}</td>
      <td>${w.name}</td>
      <td><button class="btn btn-sm btn-danger" onclick="delWorker(${w.id})">Delete</button></td>
    </tr>`;
  });
}

async function addWorker(){
  const name = document.getElementById("newName").value.trim();
  const pin = document.getElementById("newPin").value.trim();
  if(!name || !pin) return alert("Enter name and pin");
  const res = await fetch("/api/manager/workers", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ name, pin })
  });
  if(!res.ok) return alert("Failed");
  document.getElementById("newName").value="";
  document.getElementById("newPin").value="";
  await loadWorkers();
}

async function delWorker(id){
  if(!confirm("Delete worker "+id+"?")) return;
  const res = await fetch("/api/manager/workers/"+id, { method:"DELETE" });
  if(!res.ok) return alert("Failed");
  await loadWorkers();
}

let chart;
async function loadChart(){
  const res = await fetch("/api/manager/stats");
  if(!res.ok) return;
  const rows = await res.json();
  const labels = rows.map(r=>r.day);
  const values = rows.map(r=>Number(r.feedCount));

  const ctx = document.getElementById("feedChart");
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: "line",
    data: { labels, datasets: [{ label:"Feeds per day", data: values }] },
    options: { responsive:true }
  });
}

async function enroll(){
  const workerId = document.getElementById("enrollWorkerId").value.trim();
  if(!workerId) return alert("Enter worker ID");
  const msg = document.getElementById("enrollMsg");
  msg.innerHTML = "Starting enrollment...";

  const optRes = await fetch("/api/webauthn/register/options",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ workerId })
  });

  if(!optRes.ok){ msg.innerHTML="Failed to get options"; return; }
  const options = await optRes.json();

  // Browser API
  options.challenge = Uint8Array.from(atob(options.challenge.replace(/-/g,'+').replace(/_/g,'/')), c=>c.charCodeAt(0));
  options.user.id = Uint8Array.from(options.user.id, c=>c.charCodeAt(0));

  const cred = await navigator.credentials.create({ publicKey: options });

  const data = {
    id: cred.id,
    rawId: btoa(String.fromCharCode(...new Uint8Array(cred.rawId))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''),
    type: cred.type,
    response: {
      attestationObject: btoa(String.fromCharCode(...new Uint8Array(cred.response.attestationObject))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''),
      clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(cred.response.clientDataJSON))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')
    }
  };

  const verRes = await fetch("/api/webauthn/register/verify",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(data)
  });

  if(verRes.ok) msg.innerHTML = "<b>Enrolled successfully.</b>";
  else msg.innerHTML = "Enrollment failed.";
}

async function refresh(){
  await loadFeeds();
  await loadHealth();
  await loadWorkers();
  await loadChart();
}

refresh();
setInterval(loadFeeds, 5000);
setInterval(loadHealth, 5000);
</script>

</body>
</html>
